name: ğŸ“‹ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
    workflow_dispatch:

jobs:
  update-dependencies:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Update Frontend Dependencies
        run: |
          echo "ğŸ“¦ Updating frontend dependencies..."
          cd frontend
          npm update
          npm audit fix --audit-level high

      - name: ğŸ“¦ Update Backend Dependencies
        run: |
          echo "ğŸ“¦ Updating backend dependencies..."
          cd backend
          npm update
          npm audit fix --audit-level high

      - name: ğŸ”’ Security Audit
        run: |
          echo "ğŸ”’ Running security audit after updates..."
          cd frontend && npm audit --audit-level high
          cd backend && npm audit --audit-level high

      - name: ğŸ“Š Create Pull Request
        run: |
          echo "ğŸ“Š Creating dependency update pull request..."
          
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "âœ… No dependency updates needed"
            exit 0
          fi
          
          # Create and checkout branch
          BRANCH_NAME="dependency-updates-$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # Add changes
          git add .
          git commit -m "ğŸ“¦ Automated dependency updates

          ğŸ”„ Updated frontend and backend dependencies
          ğŸ”’ Applied security fixes
          ğŸ“¦ Bumped package versions if needed

          ğŸ¤– Generated by GitHub Actions
          ğŸ“… Date: $(date)"
          
          # Push branch
          git push origin $BRANCH_NAME
          
          # Create pull request
          gh pr create \
            --title "ğŸ“¦ Automated Dependency Updates" \
            --body "## ğŸ”„ Dependency Updates

          This PR contains automated updates to keep dependencies current and secure.

          ### ğŸ“¦ Updated Packages
          - Frontend dependencies updated
          - Backend dependencies updated
          - Security vulnerabilities addressed

          ### ğŸ”’ Security
          - All packages audited for high-severity vulnerabilities
          - Applied automated fixes where possible

          ### ğŸ“‹ Checklist
          - [ ] All tests pass
          - [ ] No linting errors
          - [ ] Build successful
          - [ ] Security audit clean

          ### ğŸ“Š Changes
          - Updated package-lock.json files
          - Applied security patches
          - Version bumps as needed

          ---
          ğŸ¤– *This PR will be auto-merged if all checks pass*" \
            --head main \
            --label "dependencies" \
            --label "automated"
          
          echo "âœ… Pull request created successfully!"
          else
            echo "âœ… Dependencies are already up to date"
          fi
