name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  
jobs:
  # Code Quality Checks
  quality-check:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ§ª Frontend Tests
        run: |
          cd frontend
          npm ci
          npm run lint
          npm run test:unit
          npm run build

      - name: ğŸ§ª Backend Tests
        run: |
          cd backend
          npm ci
          npm run lint
          npm test

      - name: ğŸ“Š Coverage Report
        run: |
          echo "## ğŸ“Š Test Coverage Summary" >> coverage-summary.md
          echo "- Frontend: $(cd frontend && npm run test:coverage 2>/dev/null || echo 'N/A')" >> coverage-summary.md
          echo "- Backend: $(cd backend && npm test -- --coverage 2>/dev/null || echo 'N/A')" >> coverage-summary.md

  # Performance Tests
  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸŒ Install Playwright
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps

      - name: âš¡ Run Lighthouse CI
        run: |
          cd frontend
          npm run lighthouse:ci

      - name: ğŸ“Š Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: frontend/lighthouse-report

  # Build and Deploy
  build-and-deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest
    needs: [quality-check, performance-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ— Build Production
        run: |
          echo "ğŸ— Building production assets..."
          
          # Build frontend
          cd frontend
          npm ci
          npm run build
          
          # Build backend
          cd ../backend
          npm ci
          npm run build
          
          echo "âœ… Build completed successfully!"

      - name: ğŸ“¦ Create deployment package
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          
          # Create deployment directory
          mkdir -p deployment
          
          # Copy frontend build
          cp -r frontend/.next deployment/frontend/
          
          # Copy backend build
          cp -r backend/dist deployment/backend/
          
          # Copy deployment configs
          cp render.yaml deployment/
          cp -r backend/.env.render deployment/
          cp frontend/.env.render deployment/
          
          # Create deployment script
          cat > deployment/deploy.sh << 'EOF'
          #!/bin/bash
          echo "ğŸš€ Deploying Trionex Technologies..."
          echo "Timestamp: $(date)"
          echo ""
          
          # Health check function
          health_check() {
            echo "ğŸ” Checking service health..."
            for i in {1..30}; do
              if curl -f http://localhost:10000/api/v1/health >/dev/null 2>&1; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "â³ Waiting for backend... ($i/30)"
              sleep 2
            done
          }
          
          echo "ğŸ¯ Deployment ready for Render!"
          EOF
          
          chmod +x deployment/deploy.sh

      - name: ğŸ“Š Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment/

      - name: ğŸš€ Trigger Render Deployment
        run: |
          echo "ğŸš€ Triggering Render deployment..."
          
          # Trigger frontend deployment
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_HOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main"}' \
            https://api.render.com/v1/services/trionex-frontend/deploys
          
          # Wait a moment
          sleep 10
          
          # Trigger backend deployment
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_HOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main"}' \
            https://api.render.com/v1/services/trionex-backend/deploys

      - name: â³ Monitor Deployment
        run: |
          echo "â³ Monitoring deployment progress..."
          
          # Monitor deployment status
          for i in {1..60}; do
            echo "â³ Checking deployment status... ($i/60)"
            
            # Check frontend health
            if curl -f https://trionex-frontend.onrender.com/api/health >/dev/null 2>&1; then
              echo "âœ… Frontend is live!"
            fi
            
            # Check backend health
            if curl -f https://trionex-backend.onrender.com/api/v1/health >/dev/null 2>&1; then
              echo "âœ… Backend is live!"
              break
            fi
            
            sleep 5
          done

      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ **DEPLOYMENT SUCCESSFUL!**"
          echo ""
          echo "ğŸŒ **Live Application:**"
          echo "ğŸ”— Frontend: https://trionex-frontend.onrender.com"
          echo "ğŸ”— Backend:  https://trionex-backend.onrender.com"
          echo "ğŸ”— API:      https://trionex-backend.onrender.com/api/v1"
          echo ""
          echo "âœ¨ **Trionex Technologies is now live and secure!**"
          echo ""
          echo "ğŸ“Š **Deployment Metrics:**"
          echo "- Build time: ${{ steps.build-and-deploy.outputs.build-time }}"
          echo "- Deploy time: ${{ steps.build-and-deploy.outputs.deploy-time }}"
          echo "- Total time: ${{ steps.build-and-deploy.outputs.total-time }}"

  # Notify Team
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: success()
    steps:
      - name: ğŸ“¢ Send Notification
        run: |
          echo "ğŸ“¢ Sending deployment notification..."
          
          # You can add Slack, Discord, or email notifications here
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ğŸ‰ Trionex Technologies has been successfully deployed!\n\nğŸŒ Frontend: https://trionex-frontend.onrender.com\nğŸ”§ Backend: https://trionex-backend.onrender.com",
              "channel": "#deployments"
            }' \
            "${{ secrets.SLACK_WEBHOOK_URL }}" || true

  # Rollback on Failure
  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: failure()
    steps:
      - name: ğŸ”„ Initiate Rollback
        run: |
          echo "ğŸ”„ Deployment failed! Initiating rollback..."
          
          # Trigger rollback to previous stable version
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_HOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main", "rollback": true}' \
            https://api.render.com/v1/services/trionex-frontend/deploys
